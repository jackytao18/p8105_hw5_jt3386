---
title: "Solutions for Homework 5"
author: "Jiajun Tao"
date: "2022-11-05"
output: github_document
---

```{r, include = FALSE,message=FALSE,warning=FALSE}
library(tidyverse)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	message = FALSE,
  fig.width = 8,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


### Problem 1

Our goal is to create a tidy dataframe containing data from all participants, including the subject ID, arm, and observations over time.

We first created a dataframe containing all file names using `list.files` function. Then we added the relative path to the file names in order to be used in `read_csv` function. We iterated over file names and read in data for each subject using `map` and saving the result as a new variable in the dataframe. After that we unnested the data and do some cleaning. We added variables including arm, subject ID, and made the week as a variable using `pivot_longer`.

```{r}
files_df = tibble(
  files_name = list.files("data/problem_1/")) %>% 
  mutate(
    files_path = str_c("data/problem_1/",files_name),
    data = map(files_path, read_csv)
  ) %>% 
  unnest(data) %>% 
  select(-files_path) %>% 
  mutate(
    files_name = str_remove(files_name,".csv")
  ) %>% 
  separate(files_name, into = c("arm", "subject_id"), sep = "_") %>% 
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    values_to = "observations",
    names_prefix = "week_"
  )

files_df

files_df %>% 
  ggplot(aes(x = week, y = observations)) +
  geom_line() +
  facet_grid(. ~ arm)
```

We made a spaghetti plot showing observations on each subject over time. As we can see in the plot, the observations are obviously higher in the experimental arm than in the control arm for each week. What's more, in the control arm, the observations seem to be at the same level over time, but in the experimental arm, the observations increase as time goes by.


### Problem 2

First, we imported the data.

```{r}
homicides_df = read_csv("data/problem_2/homicide-data.csv") 

homicides_df
```

The raw data has `r nrow(homicides_df)` rows and `r ncol(homicides_df)` columns. The variables include `r names(homicides_df)`.

Then we created a `city_state` variable and summarized within cities to obtain the total number of homicides and the number of unsolved homicides. I found that one observation might have a typo. The city was Tulsa, but the state was AL. I thought it should be in OK, so I just corrected it.

```{r}
homicides_df = 
  homicides_df %>% 
  mutate(
    state = ifelse(city == "Tulsa",
                   "OK",
                   state),
    city_state = str_c(city, ", ", state)
  )

n_homicides = 
  homicides_df %>% 
  group_by(city_state) %>% 
  summarise(
    n_total_homicides = n()
  )

n_homicides

n_unsolved = 
  homicides_df %>% 
  filter(disposition %in% c("Closed without arrest", "Open/No arrest")) %>% 
  group_by(city_state) %>% 
  summarise(
    n_unsolved_homicides = n()
  )

n_unsolved

n_homicides_df = left_join(n_homicides,n_unsolved)

n_homicides_df
```

We used `prop.test` to estimate the proportion of homicides that are unsolved in Baltimore, MD, and pulled the estimated proportion and confidence intervals.

```{r}
baltimore_df =
  n_homicides_df %>% 
  filter(city_state == "Baltimore, MD") 

output_p_test = 
  prop.test(x = baltimore_df$n_unsolved_homicides,
            n = baltimore_df$n_total_homicides) %>% 
  broom::tidy()

estimated_proportion = output_p_test$estimate
confidence_interval = str_c("(",
                            output_p_test$conf.low,
                            ", ",
                            output_p_test$conf.high,
                            ")")

estimated_proportion
confidence_interval
```

Now we ran `prop.test` for each of the cities in my dataset, and extracted both the proportion of unsolved homicides and the confidence interval for each. 

```{r}
prop_test_df = 
  n_homicides_df %>% 
  mutate(
    output_p_test = map2(.x = n_unsolved_homicides,
                         .y = n_total_homicides, 
                         ~broom::tidy(prop.test(x = .x, n = .y)))
  ) %>% 
  unnest(output_p_test) %>% 
  rename(estimated_proportion = estimate) %>% 
  select(city_state, n_total_homicides, n_unsolved_homicides, estimated_proportion, conf.low, conf.high)

prop_test_df
```

Finally we created a plot to show the estimates and CIs for each city in order.

```{r}
prop_test_df %>% 
  mutate(
    city_state = fct_reorder(city_state, estimated_proportion)
  ) %>% 
  ggplot(aes(x = city_state, y = estimated_proportion)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
```

